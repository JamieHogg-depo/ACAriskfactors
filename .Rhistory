raw_est <- pbapply::pblapply(list.files("data/DataLabExport",
pattern = "raw_est_*", full.names = T), readRDS)
names(raw_est) <- str_remove(
str_remove(
list.files("data/DataLabExport", pattern = "raw_est_*"), "raw_est_"), ".rds")
# Load all modelled estimates
summsa2all <- readRDS("data/summary_files/summsa2all.rds")
# Model building
model_building <- lapply(list.files("data/DataLabExport",
pattern = "model_building_*", full.names = T), readRDS)
names(model_building) <- str_remove(
str_remove(
list.files("data/DataLabExport", pattern = "model_building_*"), "model_building_"), ".rds")
# Load map
map_sa2_full <- st_read("C:/r_proj/ACAriskfactors/data/2016_SA2_Shape_min/2016_SA2_Shape_min.shp") %>%
mutate(SA2 = as.numeric(SA2_MAIN16)) %>%
filter(!str_detect(SA2_NAME, "Island")) %>%
filter(STATE_NAME != "Other Territories")
# keep non-estimated geometries
map_sa2 <- map_sa2_full %>%
left_join(.,global_obj$area_concor, by = "SA2")
# Australia outline
aus_border <- map_sa2 %>%
summarise(geometry = st_union(geometry)) %>%
st_as_sf() %>%
st_transform(4326)
# State outline
state_border <- map_sa2 %>%
mutate(state = str_sub(SA2, 1, 1)) %>%
group_by(state, STATE_NAME) %>%
summarise(geometry = st_union(geometry), .groups = "drop") %>%
filter(!st_is_empty(.)) %>%
#mutate(st_init = c("NSW", "VIC", "QLD", "SA", "WA", NA, "NT", NA)) %>%
st_as_sf() %>%
st_transform(4326)
## Other code ## --------------------------------------------------------------
# City Insets
lims <- data.frame(
xmin = c(152.6, 150.35, 144.5, 115.45, 138.1, 146.8, 148.6, 130.3),
xmax = c(153.6, 151.35, 145.5, 116.45, 139.1, 147.8, 149.6, 131.3),
ymin = -c(28, 34.4, 38.4, 32.5, 35.4, 43.4, 35.8, 13),
ymax = -c(27, 33.4, 37.4, 31.5, 34.4, 42.4, 34.8, 12),
city = c("Brisbane", "Sydney", "Melbourne", "Perth", "Adelaide", "Hobart", "Canberra", "Darwin"),
position = c("r", "r", "b", "l", "b", "b", "r", "l"),
inset_labs = c("B - Brisbane (Qld)", "S - Sydney (NSW)",
"M - Melbourne (Vic)", "P - Perth (WA)",
"A - Adelaide (SA)", "H - Hobart (Tas)",
"C - Canberra (ACT)", "D - Darwin (NT)")
) %>%
mutate(initials = str_sub(city, 1, 1))
# quantiles for IRSD
irsd_5c <- mutate(global_obj$census,
irsd_5c = case_when(
ABS_irsd_decile_nation_complete %in% c("1", "2") ~ "1 - least\nadvantaged",
ABS_irsd_decile_nation_complete %in% c("3", "4") ~ "2",
ABS_irsd_decile_nation_complete %in% c("5", "6") ~ "3",
ABS_irsd_decile_nation_complete %in% c("7", "8") ~ "4",
ABS_irsd_decile_nation_complete %in% c("9", "10") ~ "5 - most\nadvantaged"
)) %>%
dplyr::select(ps_area, irsd_5c)
## Load PHA SHA data ## --------------------------------------------------------
source("src/wrangle/getSHA.R")
## Load census data ## ---------------------------------------------------------
source("src/wrangle/loadCensusData.R")
## END SCRIPT ## --------------------------------------------------------------
lookup <- data.frame(rf = names(raw_est),
sha = c("exercise", "exercise", "alcohol",
"fruit", "obese", "overweight",
"smoking", "overweight"),
rf_full = c("Leisure physical activity",
"All physical activity",
"Alcohol",
"Diet",
"Obesity",
"Overweight",
"Current smoking",
"Risky waist circumference"))
k <- 1
rf <- names(raw_est)[k]
rf_full <- lookup[k,]$rf_full
sha_vars = paste0("shaout_", lookup[lookup$rf == rf,]$sha, "_", c("estimate", "lower", "upper"))
message("Started ", k, ": ", rf)
# load data
modelled_est <- readRDS(file = paste0("data/summary_files/", rf, "_b1.rds"))
modelled_est_nb <- readRDS(file = paste0("data/summary_files/", rf, "_b0.rds"))
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = mu_median, xmin = mu_lower, xmax = mu_upper,
y = .data[[sha_vars[1]]],
ymin = .data[[sha_vars[2]]],
ymax = .data[[sha_vars[3]]],
col = irsd_5c))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA (PHA level)",
x = "Our estimates (SA2 level)",
col = "SES")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "bottom")
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = .data[[sha_vars[1]]],
ymin = .data[[sha_vars[2]]],
ymax = .data[[sha_vars[3]]],
col = irsd_5c))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA (PHA level)",
x = "Our estimates (SA2 level)",
col = "SES")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "bottom")
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = .data[[sha_vars[1]]],
ymin = .data[[sha_vars[2]]],
ymax = .data[[sha_vars[3]]]))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA (PHA level)",
x = "Our estimates (SA2 level)",
col = "SES")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "bottom")
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = .data[[sha_vars[1]]],
ymin = .data[[sha_vars[2]]],
ymax = .data[[sha_vars[3]]]))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA (PHA level)",
x = "Our estimates (SA2 level)",
col = "SES")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "bottom")
# save object
jsave(filename = paste0("scatter_shaphavsaca_pha_", rf ,".png"),
base_folder = paste0(base_folder, "/figures"),
square = F)
for(k in 1:8){
rf <- names(raw_est)[k]
rf_full <- lookup[k,]$rf_full
sha_vars = paste0("shaout_", lookup[lookup$rf == rf,]$sha, "_", c("estimate", "lower", "upper"))
message("Started ", k, ": ", rf)
# load data
modelled_est <- readRDS(file = paste0("data/summary_files/", rf, "_b1.rds"))
#modelled_est_nb <- readRDS(file = paste0("data/summary_files/", rf, "_b0.rds"))
## Scatter: SHA PHA vs ACA #### ------------------------------------------------
# pha level
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = .data[[sha_vars[1]]],
ymin = .data[[sha_vars[2]]],
ymax = .data[[sha_vars[3]]]))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA (PHA level)",
x = "Our estimates (SA2 level)",
col = "SES")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "bottom")
# save object
jsave(filename = paste0("scatter_shaphavsaca_pha_", rf ,".png"),
base_folder = paste0(base_folder, "/figures"),
square = F)
}
modelled_est$summ$pha %>%
left_join(.,SHA_pha, by = "pha")
# cities on yaxis instead
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model),
ra = factor(ifelse(ra_sa2_3c == "Outer regional to very remote", "Outer regional\nto very remote",
as.character(ra_sa2_3c)),
levels = c("Major Cities",
"Inner Regional",
"Outer regional\nto very remote"))) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = ra, fill = out), position = position_dodge2())+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa), lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(x = out, fill = irsd_5c), position = position_dodge2())+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
addIRSDColor()
# Socioeconomic on yaxis instead
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = irsd_5c, fill = out), position = position_dodge2())+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = irsd_5c, fill = out), position = position_dodge2())+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
# save object
jsave(filename = paste0("barchart_lisa_irsd2.png"),
base_folder = paste0(base_folder, "/figures"),
square = F, ratio = 9:6)
# Socioeconomic on yaxis instead
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = irsd_5c, fill = out), position = position_dodge2())+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
# Socioeconomic on yaxis instead
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = irsd_5c, fill = out), position = "fill")+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
# Socioeconomic - fill
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model)) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = irsd_5c, fill = out), position = "fill")+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
# save object
jsave(filename = paste0("barchart_lisa_irsd3.png"),
base_folder = paste0(base_folder, "/figures"),
square = F, ratio = 9:6)
# filled
summsa2all %>%
mutate(lisa = ifelse(or_EP > 0.9, "H",
ifelse(or_EP < 0.1, "L", NA)),
out = factor(ifelse(is.na(LISA) & !is.na(lisa),
lisa, as.character(LISA)),
levels = c("HH", "H", "L", "LL")),
model = getRFFullNames(model),
ra = factor(ifelse(ra_sa2_3c == "Outer regional to very remote", "Outer regional\nto very remote",
as.character(ra_sa2_3c)),
levels = c("Major Cities",
"Inner Regional",
"Outer regional\nto very remote"))) %>%
filter(!is.na(out)) %>%
ggplot()+theme_bw()+
geom_bar(aes(y = ra, fill = out), position = "fill")+
facet_wrap(.~model)+
labs(fill = "",
x = "",
y = "")+
theme(legend.position = "bottom")+
scale_fill_manual(values = c("red", "coral", "skyblue", "royalblue"),
breaks = c("HH", "H", "L", "LL"))
# save object
jsave(filename = paste0("barchart_lisa_ra3.png"),
base_folder = paste0(base_folder, "/figures"),
square = F, ratio = 9:6)
sm <- readRDS(file = paste0("data/summary_files/smoking_b1.rds"))
ob <- readRDS(file = paste0("data/summary_files/obesity_b1.rds"))
## Smoking
sm_plt <- sm$summ$sa2 %>%
left_join(.,SHA_pha, by = "pha") %>%
mutate(irsd_5c = irsd_5c) %>%
ggplot(aes(x = mu_median, xmin = mu_lower, xmax = mu_upper,
y = shaout_smoking_estimate,
ymin = shaout_smoking_lower,
ymax = shaout_smoking_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Current smoking",
x = "Our estimates")+
ylim(0,1)+xlim(0,1)
sm_plt
sm$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_smoking_estimate,
ymin = shaout_smoking_lower,
ymax = shaout_smoking_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Current smoking",
x = "Our estimates")+
ylim(0,1)+xlim(0,1)
## Obesity
ob_plt <- ob$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_obese_estimate,
ymin = shaout_obese_lower,
ymax = shaout_obese_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Obesity",
x = "")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "none")
ob_plt
lay <- rbind(c(1),
c(2))
full_plt <- arrangeGrob(grobs = list(ob_plt, sm_plt),
layout_matrix  = lay)
full_plt
plot(full_plt)
sm_plt <- sm$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_smoking_estimate,
ymin = shaout_smoking_lower,
ymax = shaout_smoking_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Current smoking",
x = "Our estimates")+
ylim(0,1)+xlim(0,1)
## Obesity
ob_plt <- ob$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_obese_estimate,
ymin = shaout_obese_lower,
ymax = shaout_obese_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Obesity",
x = "")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "none")
## Full plot
lay <- rbind(c(1),
c(2))
full_plt <- arrangeGrob(grobs = list(ob_plt, sm_plt),
layout_matrix  = lay)
plot(full_plt)
jsave(filename = paste0("scattersha_smokingobesity_pha.png"),
base_folder = paste0(base_folder, "/figures"),
plot = full_plt,
square = F)
# cleanup
rm(full_plt, sm_plt, ob_plt)
jsave(filename = paste0("scattersha_smokingobesity_pha.png"),
base_folder = paste0(base_folder, "/figures"),
plot = full_plt,
square = T)
# cleanup
rm(full_plt, sm_plt, ob_plt)
lay <- rbind(c(1),
c(2))
full_plt <- arrangeGrob(grobs = list(ob_plt, sm_plt),
layout_matrix  = lay)
# save object
jsave(filename = paste0("scattersha_smokingobesity_pha.png"),
base_folder = paste0(base_folder, "/figures"),
plot = full_plt,
square = T)
sm_plt <- sm$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_smoking_estimate,
ymin = shaout_smoking_lower,
ymax = shaout_smoking_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Current smoking",
x = "Our estimates")+
ylim(0,1)+xlim(0,1)
## Obesity
ob_plt <- ob$summ$pha %>%
left_join(.,SHA_pha, by = "pha") %>%
ggplot(aes(x = median, xmin = lower, xmax = upper,
y = shaout_obese_estimate,
ymin = shaout_obese_lower,
ymax = shaout_obese_upper))+
theme_bw()+
geom_errorbar(col = "grey")+
geom_errorbarh(col = "grey")+
geom_abline()+
geom_point()+
labs(y = "SHAA",
title = "Obesity",
x = "")+
ylim(0,1)+xlim(0,1)+
theme(legend.position = "none")
## Full plot
lay <- rbind(c(1),
c(2))
full_plt <- arrangeGrob(grobs = list(ob_plt, sm_plt),
layout_matrix  = lay)
# save object
jsave(filename = paste0("scattersha_smokingobesity_pha.png"),
base_folder = paste0(base_folder, "/figures"),
plot = full_plt,
square = T)
# cleanup
rm(full_plt, sm_plt, ob_plt)
